generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}



enum Role {
  ADMIN
  USER
}

enum AssignmentStatus {
  LOCKED
  UNLOCKED
}

enum PostStatus {
  DRAFT
  PUBLISHED
}

enum LeadJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  QUEUED
}

model User {
  id           String   @id @default(cuid())
  userId       String   @unique
  passwordHash String
  role         Role     @default(USER)
  email        String? @unique
  imageUrl     String?
  canRequestLeads Boolean @default(false)
  createdAt    DateTime @default(now())
  files        File[]   @relation("UploadedFiles")
  assignments  Assignment[]
  blogPosts    BlogPost[]
  leadJobs     LeadJob[]
  leadAudits   LeadAudit[]
  leadAuditLogs LeadAuditLog[]
}

model File {
  id                String   @id @default(cuid())
  title             String
  originalName      String
  storedName        String
  mimeType          String
  size              Int
  createdAt         DateTime @default(now())
  uploadedByAdminId String
  uploadedByAdmin   User     @relation("UploadedFiles", fields: [uploadedByAdminId], references: [id])
  assignments       Assignment[]
}

model Assignment {
  id        String           @id @default(cuid())
  userId    String
  fileId    String
  status    AssignmentStatus @default(LOCKED)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id])
  file File @relation(fields: [fileId], references: [id])

  @@unique([userId, fileId])
}

model BlogPost {
  id              String     @id @default(cuid())
  title           String
  slug            String     @unique
  excerpt         String
  content         String
  coverImageUrl   String?
  metaImageUrl    String?
  metaTitle       String?
  metaDescription String?
  tags            String[]
  categories      String[]   @default([])
  videoUrl        String?
  readMinutesOverride Int?
  tocOverride     String?
  seoScore        Int        @default(0)
  humanScore      Int        @default(0)
  customPublished String?
  publishedAt     DateTime?
  status          PostStatus @default(DRAFT)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  authorId        String?
  author          User?      @relation(fields: [authorId], references: [id])
}

model LeadJob {
  id          String        @id @default(cuid())
  userId      String
  keyword     String
  context     String?
  country     String?
  state       String?
  city        String?
  businessSize String?
  industry    String?
  size        String?
  leadsTarget Int
  status      LeadJobStatus @default(PENDING)
  progress    Int           @default(0)
  safeMode    Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  user        User          @relation(fields: [userId], references: [id])
  results     LeadResult[]
  audits      LeadAudit[]
  auditLogs   LeadAuditLog[]

  @@index([userId, createdAt])
}

model LeadResult {
  id           String   @id @default(cuid())
  jobId        String
  businessName String
  industry     String?
  website      String?
  phone        String?
  email        String?
  addressLine1 String?
  addressLine2 String?
  street       String?
  city         String?
  state        String?
  postalCode   String?
  postcode     String?
  country      String?
  source       String
  sourceUrl    String?
  contactFirstName String?
  contactLastName  String?
  contactRole      String?
  contactEmail     String?
  ownerName        String?
  ein              String?
  businessCapital  String?
  employeeCount    Int?
  confidence   Float?
  notes        String?
  isHidden     Boolean  @default(false)
  isArchived   Boolean  @default(false)
  rawJson      Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  job          LeadJob  @relation(fields: [jobId], references: [id])

  @@index([jobId, createdAt])
}

model LeadAudit {
  id           String   @id @default(cuid())
  userId       String
  jobId        String?
  provider     String
  status       String
  requestCount Int      @default(1)
  resultsCount Int      @default(0)
  metadata     Json?
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  job  LeadJob? @relation(fields: [jobId], references: [id])

  @@index([userId, createdAt])
  @@index([jobId, createdAt])
}

model LeadAuditLog {
  id         String   @id @default(cuid())
  userId     String
  jobId      String?
  action     String
  providerId String
  count      Int      @default(0)
  meta       Json?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  job  LeadJob? @relation(fields: [jobId], references: [id])

  @@index([userId, createdAt])
  @@index([jobId, createdAt])
}
